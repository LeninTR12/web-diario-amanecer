---
import { articlesHandler } from "@/lib/handlers/articles";
import { categoriesHandler } from "@/lib/handlers/categories";
import type { Article, Category, Meta } from "@/lib/types";
import ListLayout from "@/layouts/list.astro";
import WideCard from "@/components/cards/wideCard.astro";
import { scopesHandler } from "@/lib/handlers/scopes";
import { decode } from "html-entities";
import { SITE } from "@/lib/config";
import RecentNews from "../_home/recentNews.astro";
import BigArticleCard from "@/components/cards/bigArticleCard.astro";


const { categoria } = Astro.params;

const categoryXCat = await categoriesHandler.oneCategoryBySlug(categoria as string);
const categoryXScope = await scopesHandler.oneScopeSlug(categoria as string);
const category = categoryXCat || categoryXScope;

 if (!category) return Astro.redirect("/404");

const allArticles: Article[] = categoryXCat
  ?await articlesHandler.articlesByCategory(category.id) 
  : await articlesHandler.articlesByScope(category.id); 

 if(allArticles.length === 0) return Astro.redirect("/404");

const bigArticle = allArticles[0];
const articles = allArticles.slice(1, allArticles.length);

 const title = categoryXCat 
                ? `Noticias en ${(category.name).toLowerCase()}`
                : `Noticias del Ã¡mbito ${(category.name).toLowerCase()}`;

const meta: Meta = {
  title:`${title} - ${SITE.title}`,
  metaTitle: title,
  description: category.description,
  type: "website",
  ogImage: bigArticle?._embedded["wp:featuredmedia"]?.[0]["source_url"],
  ogImageAlt: decode(String (bigArticle?.title.rendered)),
};

---
<ListLayout headerTitle={title} meta={meta}>
  <div class="flex flex-col lg:flex-row lg:w-[1024px] max-w-[1024px] ">
    <BigArticleCard
      article={bigArticle}
      category={category}
    />
    <RecentNews page="category" />
  </div>
  <div class="flex justify-start lg:w-[1024px] max-w-[1024px] ">
  {articles.length === 0 
    ? null
    :(
    <ul class="flex flex-col max-w-[733px] gap-5 flex-1 ">
      {
        articles.map((article) => (
          <WideCard
            category={category}
            article={article}
            isLast={articles.lastIndexOf(article) === articles.length - 1}
          />
        ))
      }
    </ul>
    
    <div class="flex " ></div>
    )}
    </div>
    <!-- {
      articles.length > SITE.postsPerPage ? (
        <Pagination
          length={page.lastPage}
          currentUrl={page.url.current}
          currentPage={page.currentPage}
          firstUrl={`/${firstPath}`}
          prevUrl={page.url.prev}
          nextUrl={page.url.next}
          lastUrl={`/${firstPath}/${page.lastPage}`}
        />
      ) : null
    } -->
  </ListLayout>


