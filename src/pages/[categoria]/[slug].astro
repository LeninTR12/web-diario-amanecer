---
import { articlesHandler } from "@/lib/handlers/articles";
import { categoriesHandler } from "@/lib/handlers/categories";
import { htmlToText } from "@/lib/utils/letter";
import type { Article, ArticleMeta, Category } from "@/lib/types";
import BaseLayout from "@/layouts/base.astro";
import ContentLayout from "@/layouts/content.astro";
import ArticleHeader from "../articles/_components/article-header.astro";
import { scopesHandler } from "@/lib/handlers/scopes";
import Content from "../articles/_components/article-content.astro";

const { categoria, slug } = Astro.params;

const categoryXcat: Category = await categoriesHandler.oneCategoryBySlug(categoria as string);
const categoryXScope = await scopesHandler.oneScopeSlug(categoria as string);

const category = categoryXcat || categoryXScope;
if (!category) return Astro.redirect("/404");

const article:Article = await articlesHandler.oneArticleBySlug(slug as string);

if (!article) return Astro.redirect("/404");

const meta: ArticleMeta = {
  title: article.title.rendered,
  metaTitle: article.title.rendered,
  description: htmlToText(article.excerpt.rendered),
  type: "article",
  ogImage: article._embedded["wp:featuredmedia"]?.[0]["source_url"],
  ogImageAlt: article.title.rendered,
  publishedTime: article.date,
  lastModified: article.modified,
};

---

<BaseLayout meta={meta}>
  <ArticleHeader article={article} />
  <ContentLayout>
      <Content article = {article} />
    </ContentLayout>
</BaseLayout>
